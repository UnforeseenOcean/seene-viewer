<html>
<head>
    <title>Seene</title>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/three.js/r61/three.min.js"></script>

    <style type="text/css">
        #model {
            width: 512px;
            height: 512px;
            position: absolute;
        }
    </style>
</head>
<body>
    <script type="text/javascript">
        var model = (function () {
            return {
                width: 0,
                height: 0,
                renderer: null,
                camera: null,
                scene: null,
                axis: null,

                initialize: function (div_id, buffer) {
                    var div = $(div_id);
                    this.width = div.width();
                    this.height = div.height();

                    this.camera = new THREE.PerspectiveCamera(25, this.width / this.height, 1, 10000);
                    this.camera.position.x = 1000;
                    this.camera.position.y = 1500;
                    this.camera.lookAt(new THREE.Vector3(0, 0, 0));

                    this.scene = this.create_scene(buffer);

                    this.renderer = new THREE.WebGLRenderer({antialias: false});
                    this.renderer.setSize(this.width, this.height);
                    this.renderer.setClearColor(0, 1);

                    div.append(this.renderer.domElement);
                },

                create_scene: function (buffer) {
                    this.read_heightmap(buffer, this.read_header(buffer));

                    var scene = new THREE.Scene();
                    scene.add(new THREE.AxisHelper(200));

                    return scene;
                },

                render: function () {
                    this.renderer.render(this.scene, this.camera);
                },

                //
                // Private stuff
                //

                read_header: function (buffer) {
                    function read_int(buffer, offset) {
                        return new Int32Array(buffer, offset, 1)[0];
                    }

                    function read_float(buffer, offset) {
                        return new Float32Array(buffer, offset, 1)[0];
                    }

                    return {
                        version: read_int(buffer, 0),
                        camera_width: read_int(buffer, 4),
                        camera_height: read_int(buffer, 8),
                        camera_fx: read_float(buffer, 12),
                        camera_fy: read_float(buffer, 16),
                        camera_k1: read_float(buffer, 20),
                        camera_k2: read_float(buffer, 24),
                        depthmap_width: read_int(buffer, 28),
                        depthmap_height: read_int(buffer, 32),
                        header_size: 36
                    };
                },

                read_heightmap: function (buffer, header) {
                    console.log(new Float32Array(buffer, header.header_size, header.depthmap_width * header.depthmap_height));
                }
            };
        })();

        function load_model(callback) {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "./scene.oemodel", true);
            xhr.responseType = "arraybuffer";

            xhr.onload = function(e) {
                callback(this.response);
            };

            xhr.send();
        }

        $(function () {
            load_model(function (buffer) {
                model.initialize("#model", buffer)
                model.render();
            });
        });
    </script>
    <div id="model"></div>
</body>
</html>
